<h1>Bank Card Management Service</h1>

<p>
  Backend-приложение для управления банковскими картами, переводами между собственными картами
  и запросами на блокировку карт.
</p>

<p>
  Проект реализован в рамках тестового задания на позицию
  <b>Junior Java Backend Developer</b> и демонстрирует работу с REST API,
  безопасностью, бизнес-валидацией, базой данных и тестированием.
</p>

<hr />

<h2>Содержание</h2>
<ul>
  <li><a href="#features">Основная функциональность</a></li>
  <li><a href="#stack">Технологический стек</a></li>
  <li><a href="#architecture">Архитектура приложения</a></li>
  <li><a href="#errors">Обработка ошибок</a></li>
  <li><a href="#api">Документация API</a></li>
  <li><a href="#run">Запуск проекта</a></li>
  <li><a href="#users">Тестовые пользователи</a></li>
  <li><a href="#security">Примечания по безопасности</a></li>
</ul>

<hr />

<h2 id="features">Основная функциональность</h2>

<h3>Аутентификация и безопасность</h3>
<ul>
  <li>Stateless-аутентификация на основе JWT (Bearer Token).</li>
  <li>Ролевой доступ: <code>ADMIN</code> и <code>USER</code>.</li>
  <li>Доступ к административным эндпоинтам ограничен ролью <code>ADMIN</code>.</li>
  <li>Пароли пользователей хранятся в виде BCrypt-хэшей.</li>
  <li>Полный номер карты (PAN) не хранится и не возвращается в открытом виде.</li>
  <li>
    В API номер карты отображается в виде маски:
    <code>**** **** **** 1234</code>.
  </li>
</ul>

<h3>Работа с банковскими картами</h3>
<ul>
  <li>
    <b>ADMIN</b>:
    <ul>
      <li>создаёт карты;</li>
      <li>изменяет статус карт;</li>
      <li>удаляет карты;</li>
      <li>просматривает все карты (фильтрация и пагинация).</li>
    </ul>
  </li>
  <li>
    <b>USER</b>:
    <ul>
      <li>просматривает только свои карты;</li>
      <li>получает список карт с пагинацией и фильтрами;</li>
      <li>получает конкретную карту по идентификатору.</li>
    </ul>
  </li>
</ul>

<h4>Статусы карт</h4>
<ul>
  <li>
    В базе данных хранятся статусы:
    <code>ACTIVE</code>, <code>BLOCKED</code>.
  </li>
  <li>
    Статус <code>EXPIRED</code> вычисляется динамически на основе срока действия карты:
    <ul>
      <li>не хранится в БД;</li>
      <li>учитывается в бизнес-логике;</li>
      <li>возвращается в API.</li>
    </ul>
  </li>
  <li>Для карт со статусом <code>EXPIRED</code> любые операции запрещены.</li>
</ul>

<h4>Удаление карт (ADMIN)</h4>
<ul>
  <li>
    В текущей реализации используется <b>физическое удаление карты</b> из базы данных.
  </li>
  <li>
    Удаление возможно <b>только для «свежих» карт</b>, которые:
    <ul>
      <li>не участвовали ни в одной операции перевода (<code>transfers</code>);</li>
      <li>не имеют связанных запросов на блокировку (<code>block_requests</code>).</li>
    </ul>
  </li>
  <li>
    Фактически это означает, что удаляться могут только карты,
    которые были созданы, но не использовались в бизнес-операциях.
  </li>
  <li>
    Ограничение обеспечивается внешними ключами на уровне базы данных
    и бизнес-логикой приложения.
  </li>
  <li>
    При наличии связанных записей попытка удаления приводит к ошибке
    <code>409 CONFLICT</code>.
  </li>
</ul>

<p>
  <b>Примечание:</b><br />
  В реальных финтех- и банковских системах карты, как правило, не удаляются физически,
  а переводятся в финальное состояние (например, <code>CLOSED</code>),
  чтобы сохранить историю операций и обеспечить аудит.
  В рамках данного тестового задания выбран упрощённый и технически корректный вариант
  с физическим удалением только для новых, неиспользованных карт.
</p>

<h3>Переводы между картами</h3>
<ul>
  <li>Переводы возможны только между картами одного пользователя.</li>
  <li>
    Ограничения:
    <ul>
      <li>карты должны быть активными и не истёкшими;</li>
      <li>сумма перевода должна быть больше нуля;</li>
      <li>баланс карты-отправителя должен быть достаточным;</li>
      <li>валюта карт должна совпадать.</li>
    </ul>
  </li>
  <li>Операция перевода транзакционная.</li>
  <li>
    Используется optimistic locking (<code>@Version</code>)
    для защиты от конкурентных обновлений.
  </li>
</ul>

<h3>Запросы на блокировку карт</h3>
<ul>
  <li><b>USER</b> может отправить запрос на блокировку своей карты.</li>
  <li>
    <b>ADMIN</b> может:
    <ul>
      <li>просматривать все запросы;</li>
      <li>подтверждать или отклонять запросы.</li>
    </ul>
  </li>
  <li>Запросы блокировки хранятся отдельно от карт.</li>
</ul>

<hr />

<h2 id="stack">Технологический стек</h2>
<ul>
  <li>Java 17+ (проект разрабатывался и тестировался на Java 21)</li>
  <li>Spring Boot</li>
  <li>Spring Security</li>
  <li>JWT (Bearer Token)</li>
  <li>Spring Data JPA (Hibernate)</li>
  <li>PostgreSQL</li>
  <li>Liquibase</li>
  <li>OpenAPI / Swagger</li>
  <li>JUnit 5, Mockito</li>
  <li>Docker, Docker Compose</li>
</ul>

<hr />

<h2 id="architecture">Архитектура приложения</h2>
<p>Используется классическая слоистая архитектура:</p>
<ul>
  <li><code>controller</code> — REST-контроллеры</li>
  <li><code>service</code> — бизнес-логика</li>
  <li><code>repository</code> — доступ к данным</li>
  <li><code>dto</code> — модели API</li>
  <li><code>security</code> — JWT и конфигурация безопасности</li>
  <li><code>exception</code> — централизованная обработка ошибок</li>
</ul>
<p>Прямой доступ контроллеров к репозиториям отсутствует.</p>

<hr />

<h2 id="errors">Обработка ошибок</h2>
<ul>
  <li>Валидация входных данных выполняется через Bean Validation (<code>@Valid</code>).</li>
  <li>Ошибки обрабатываются централизованно через <code>@RestControllerAdvice</code>.</li>
  <li>API возвращает единый формат ошибок.</li>
</ul>

<hr />

<h2 id="api">Документация API</h2>
<p>Swagger UI доступен после запуска приложения:</p>
<pre><code>http://localhost:8080/swagger-ui/index.html</code></pre>

<hr />

<h2 id="run">Запуск проекта</h2>

<h3>Требования</h3>
<ul>
  <li>Java 17+</li>
  <li>Docker, Docker Compose</li>
  <li>Maven</li>
</ul>

<h3>Запуск базы данных</h3>
<pre><code>docker compose up -d</code></pre>

<h3>Запуск приложения</h3>
<pre><code>mvn clean test
mvn spring-boot:run</code></pre>

<hr />

<h2 id="users">Тестовые пользователи</h2>
<p>Пользователи создаются автоматически через Liquibase-миграции.</p>

<table>
  <thead>
    <tr>
      <th align="right">Роль</th>
      <th align="left">Логин</th>
      <th align="left">Пароль</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td align="right">ADMIN</td>
      <td align="left"><code>admin</code></td>
      <td align="left"><code>admin</code></td>
    </tr>
    <tr>
      <td align="right">USER</td>
      <td align="left"><code>user</code></td>
      <td align="left"><code>user</code></td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="security">Примечания по безопасности</h2>
<ul>
  <li>Полный номер карты хранится только в зашифрованном виде.</li>
  <li>В базе данных хранится зашифрованный PAN и последние 4 цифры.</li>
  <li>В API номер карты всегда возвращается в замаскированном виде.</li>
</ul>
